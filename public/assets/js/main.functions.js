import{apps_list,template_sip_webrtc_data_uuid,template_sip_global_data_uuid,host,tenant_uuid,token_session}from"./index";export async function update_sip_template_endpoint(e){document.getElementById("title_text").innerText="Patientez",document.getElementById("final-step-one").innerHTML='<i class="fa-solid fa-spinner fa-spin-pulse"></i>',document.getElementById("final-step-two").innerHTML='<i class="fa-solid fa-spinner fa-spin-pulse"></i>',document.getElementById("final-step-three").innerHTML='<i class="fa-solid fa-spinner fa-spin-pulse"></i>';let t="no";"rtp_symmetric,rewrite_contact"==e.nat.sip_value&&(t="yes");const a={method:"PUT",headers:{"Content-Type":"application/json","Wazo-Tenant":tenant_uuid,"X-Auth-Token":token_session},body:JSON.stringify({endpoint_section_options:[["rtp_timeout","7200"],["allow_transfer","yes"],["use_ptime","yes"],["callerid","wazo"],["direct_media","no"],["dtmf_mode","rfc4733"],["language",e.locale.sip_value],["inband_progress","no"],["rtp_timeout_hold","0"],["timers_sess_expires","600"],["timers_min_se","90"],["trust_id_inbound","no"],["allow_subscribe","yes"],["allow",e.codecs.sip_value],["rewrite_contact",t],["rtp_symmetric",t],["moh_suggest",e.moh.sip_value]]})};try{let t=await fetch(host+"/api/confd/1.1/endpoints/sip/templates/"+template_sip_global_data_uuid,a);null==t||204==t.status||t.ok?update_sip_template_webrtc_endpoint(e):console.log("no auth")}catch(e){console.error("Erreur :",e)}}async function update_sip_template_webrtc_endpoint(e){const t={method:"PUT",headers:{"Content-Type":"application/json","Wazo-Tenant":tenant_uuid,"X-Auth-Token":token_session},body:JSON.stringify({endpoint_section_options:[["webrtc","yes"],["max_audio_streams","1"],["max_video_streams","25"],["allow",e.app_codecs.sip_value],["dtls_auto_generate_cert","yes"]]})};try{let a=await fetch(host+"/api/confd/1.1/endpoints/sip/templates/"+template_sip_webrtc_data_uuid,t);null==a||204==a.status||a.ok?(document.getElementById("final-step-one").innerHTML='<i class="fa-solid fa-circle-check text-success fa-beat"></i>',update_apps(apps_list,e)):console.log("no auth")}catch(e){console.error("Erreur :",e)}}async function updateORcreate_ext_apps(e,t,a){const s="/api/confd/1.1/external/apps/"+e;let n,l;"wazo-euc-application-mobile"==e?(l=0==a?"PUT":"POST",n={turn_servers:'[{"urls":"turn:'+t.app_ma.server_turn_ma+":"+t.app_ma.server_port_turn_ma+'","username":"'+t.app_ma.server_username_turn_ma+'","credential":"'+t.app_ma.server_password_turn_ma+'"}]'}):"wazo-euc-application-desktop"!=e&&"wazo-euc-application-web"!=e||(l=0==a?"PUT":"POST",n={stun_servers:"stun:"+t.app_wda.server_stun_wda+":"+t.app_wda.server_port_stun_wda});const o={method:l,headers:{"Content-Type":"application/json","Wazo-Tenant":tenant_uuid,"X-Auth-Token":token_session},body:JSON.stringify({configuration:n,label:e})};try{let t=await fetch(host+s,o);null==t||204==t.status||t.ok?console.log(e+": OK"):console.log(e+": NOK")}catch(e){console.error("Erreur :",e)}}async function update_apps(e,t){if(console.log(e),e.total>0&&("true"==t.app_ma.enable||"true"==t.app_wda.enable)){console.log("Etat MA = "+t.app_ma.enable),console.log("Etat WDA = "+t.app_wda.enable);let a=e.items,s=t.app_labels.activate_labels;for(let e=0;e<s.length;e++){console.log(a),console.log("Demande d'app conf: "+s[e]);const n=t=>t.name===s[e];console.log("CHECK ITEM");let l=a.some(n);console.log(l),console.log("FIN CHECK");let o=s[e];!0===l?(console.log("L'app existe deja alors"),console.log("BOUCLE UPDATE"),o==s[e]?(console.log("boucle update label: "+o),await updateORcreate_ext_apps(o,t,0)):console.log("erreur boucle update")):!1===l&&(console.log("L'app N'existe PAS deja alors"),console.log("BOUCLE CREATE"),console.log(s[e]),console.log("boucle create label: "+s[e]),await updateORcreate_ext_apps(s[e],t,1))}}else if(0!=e.total||"true"!=t.app_ma.enable&&"true"!=t.app_wda.enable)console.log("il ny a pas d'app à configurer");else{console.log("il ny a pas d'app configuree : "),console.log("MA2 = "+t.app_ma.enable),console.log("WDA2 = "+t.app_wda.enable);let e=t.app_labels.activate_labels;for(let a=0;a<e.length;a++)console.log("create app : "+e[a]),await updateORcreate_ext_apps(e[a],t,1)}setTimeout((function(){let e=document.getElementsByClassName("submit"),t=document.getElementsByClassName("backward");for(let t of e)t.setAttribute("disabled","yes");for(let e of t)e.setAttribute("disabled","yes");document.getElementById("final-step-two").innerHTML='<i class="fa-solid fa-circle-check text-success fa-beat"></i>',document.getElementById("final-step-three").innerHTML='<i class="fa-solid fa-circle-check text-success fa-beat"></i>',document.getElementById("title_text").innerText="Terminé !",document.getElementById("subtitle_text").innerText=""}),1500)}export function create_nice_select(e,t){e.after($("<div></div>").addClass("nice-select").addClass(e.attr("class")||"").addClass(e.attr("disabled")?"disabled":"").attr("tabindex",e.attr("disabled")?null:"0").html('<span class="current"></span><ul class="list"></ul>'));var a=e.next(),s=e.find("option"),n=e.find("option:selected");a.find(".current").html(n.data("display")||n.text()),s.each((function(e){var s=$(this),n=s.data("display");a.find("ul").append($("<li></li>").attr("data-value",s.val()).attr("data-display",n||null).addClass("option "+t+(s.is(":selected")?" selected":"")+(s.is(":disabled")?" disabled":"")).html(s.text()))}))}export function add_info_to_summary(e){const t=document.getElementsByClassName("check_before_send")[0],a=document.getElementsByClassName("check_before_send_app")[0];t.innerHTML="<li><span class='font-weight-bold'> Langue :</span> "+e.locale.label+"</li><li><span class='font-weight-bold'>Codecs activés :</span> "+e.codecs.label+"</li><li><span class='font-weight-bold'>Musique d'attente :</span> "+e.moh.label+"</li><li><span class='font-weight-bold'>Nat Actif :</span> "+e.nat.label+"</li>",a.innerHTML="<li><span class='font-weight-bold'>Codecs activés :</span> "+e.app_codecs.label+"</li><li><span class='font-weight-bold'>Service STUN (Web & Desktop) :</span> "+("true"===e.app_wda.enable?"Oui":"Non")+"</li><li><span class='font-weight-bold'>Service TURN (Mobile) :</span> "+("true"===e.app_ma.enable?"Oui":"Non")+"</li>"}