import"@fortawesome/fontawesome-free/js/fontawesome";import"@fortawesome/fontawesome-free/js/solid";import tippy from"tippy.js";import{App}from"@wazo/euc-plugins-sdk";import"./survey_func";import{update_sip_template_endpoint,create_nice_select,add_info_to_summary}from"./main.functions";import{codec_list_text,locale_list_wazo}from"./main.const";const version="© [AIV]{date}[/AIV] FMW - Pour Wazo Communication - [AIV]v{version}[/AIV]";document.getElementsByClassName("copy")[0].innerHTML=version;const clm=require("country-locale-map"),app=new App;export let template_sip_global_data_uuid="";export let template_sip_webrtc_data_uuid="";export let apps_list="";export let host;export let tenant_uuid;export let token_session;const codec_list=JSON.parse(codec_list_text),locale_list=JSON.parse(locale_list_wazo),btn_next=document.getElementsByClassName("forward"),btn_submit=document.getElementsByClassName("submit"),btn_stun=document.getElementsByClassName("active_stun_wda"),btn_turn=document.getElementsByClassName("active_turn_ma");tippy("[data-tippy-content]",{placement:"left-start",animation:"perspective"});export const keys={codecs:[],locale:[],moh:[],nat:[],app_codecs:[],app_wda:[],app_ma:[]};for(let e of btn_next)e.addEventListener("click",(function(e){e.preventDefault;let t={sip_value:["!all"],label:[]},a={sip_value:[],label:[]},s={sip_value:[],label:[]},n={sip_value:[],label:[]},l={sip_value:["!all"],label:[]},o={activate_labels:[]},c={enable:[],label_web:[],label_desktop:[],server_stun_wda:[],server_port_stun_wda:[]},i={enable:[],label:[],server_turn_ma:[],server_port_turn_ma:[],server_username_turn_ma:[],server_password_turn_ma:[]};$("#codec_activable input[type=checkbox]:checked").each((function(){jQuery(this).is(":checked")&&(t.sip_value+=","+$(this).val(),t.label+=this.dataset.label+" ")})),$("#codec_activable_webrtc input[type=checkbox]:checked").each((function(){jQuery(this).is(":checked")&&(l.sip_value+=","+$(this).val(),l.label+=this.dataset.label+" ")})),$(".locales.selected").each((function(){a.sip_value+=this.dataset.value,a.label+=$(this).text()})),$(".moh.selected").each((function(){s.sip_value+=this.dataset.value,s.label+=$(this).text()})),$(".nat_tenant li.selected").each((function(){n.sip_value+=this.dataset.value,n.label+=$(this).text()})),$("#active_stun_wda").each((function(){c.enable+="yes"===this.value,"yes"===this.value&&o.activate_labels.push("wazo-euc-application-web","wazo-euc-application-desktop"),c.server_stun_wda+=$("input[name='server_stun_wda']").val(),c.server_port_stun_wda+=$("input[name='server_port_stun_wda']").val()})),$("#active_turn_ma").each((function(){i.enable+="yes"===this.value,"yes"===this.value&&o.activate_labels.push("wazo-euc-application-mobile"),i.server_turn_ma+=$("input[name='server_turn_ma']").val(),i.server_port_turn_ma+=$("input[name='server_port_turn_ma']").val(),i.server_username_turn_ma+=$("input[name='server_username_turn_ma']").val(),i.server_password_turn_ma+=$("input[name='server_password_turn_ma']").val()})),keys.codecs=t,keys.locale=a,keys.moh=s,keys.nat=n,keys.app_labels=o,keys.app_codecs=l,keys.app_ma=i,keys.app_wda=c,add_info_to_summary(keys)}));for(let e of btn_submit)e.addEventListener("click",(function(e){update_sip_template_endpoint(keys)}));for(let e of btn_stun){let t=document.getElementsByName("server_stun_wda"),a=document.getElementsByName("server_port_stun_wda");e.onchange=()=>{for(let e of t)e.classList.toggle("required");for(let e of a)e.classList.toggle("required");$(".server_stun_wda, .server_port_stun_wda").toggle("show")}}for(let e of btn_turn){let t=document.getElementsByName("server_turn_ma"),a=document.getElementsByName("server_port_turn_ma"),s=document.getElementsByName("server_username_turn_ma"),n=document.getElementsByName("server_password_turn_ma");e.onchange=()=>{for(let e of t)e.classList.toggle("required");for(let e of a)e.classList.toggle("required");for(let e of s)e.classList.toggle("required");for(let e of n)e.classList.toggle("required");$(".server_turn_ma, .server_port_turn_ma, .server_username_turn_ma, .server_password_turn_ma").toggle("show")}}(async()=>{await app.initialize();const e=app.getContext();tenant_uuid=e.app.extra.tenant,host="https://"+e.app.extra.instance.host,token_session=e.app.extra.instance.session.token;const t={method:"GET",headers:{"Content-Type":"application/json","Wazo-Tenant":tenant_uuid,"X-Auth-Token":token_session}},a=await fetch(host+"/api/auth/0.1/tenants?offset=0",t).then((e=>e.json())),s=await fetch(host+"/api/confd/1.1/endpoints/sip/templates?recurse=false&search=global",t).then((e=>e.json())),n=await fetch(host+"/api/confd/1.1/endpoints/sip/templates?recurse=false&search=webrtc",t).then((e=>e.json())),l=await fetch(host+"/api/confd/1.1/moh?recurse=false",t).then((e=>e.json()));apps_list=await fetch(host+"/api/confd/1.1/external/apps?recurse=false",t).then((e=>e.json()));let o="";if(apps_list.total>0){let e=apps_list.items;for(let t=0;t<e.length;t++)"wazo-euc-application-mobile"==e[t].name&&(o+="Wazo Mobile "),"wazo-euc-application-web"==e[t].name&&(o+="Wazo Web "),"wazo-euc-application-desktop"==e[t].name&&(o+="Wazo Desktop ")}const c=apps_list.total>0?"Oui ("+o+")":(document.getElementById("step1_tippy_app_show").style.display="none","Non"),i=s.items[0].endpoint_section_options;template_sip_global_data_uuid=s.items[0].uuid;const r=n.items[0].endpoint_section_options;template_sip_webrtc_data_uuid=n.items[0].uuid;const _=new Array;for(let e=0;e<i.length;e++)for(let t=0;t<i[e].length;t++)0==[t]&&(_[i[e][t]]="no value"),1==[t]&&(_[i[e][t-1]]=i[e][t]);const p=new Array;for(let e=0;e<r.length;e++)for(let t=0;t<r[e].length;t++)0==[t]&&(p[r[e][t]]="no value"),1==[t]&&(p[r[e][t-1]]=r[e][t]);let m=_.language,u=_.allow.split(","),d="";for(var v in u){let e=u[v];for(var h=0;h<codec_list.length;++h){let t=codec_list[h];if(t.value==e){d+=t.name+" ";break}}}let f=p.allow.split(","),b="";for(var v in f){let e=f[v];for(h=0;h<codec_list.length;++h){let t=codec_list[h];if(t.value==e){b+=t.name+" ";break}}}let g="",y=$("#moh_tenant");for(let e=0;e<l.items.length;e++)g+='<option value="'+l.items[e].name+'">'+l.items[e].label+"</option>";y.append(g),y.each((function(){var e=$(this),t=$(this).next(".nice-select"),a=t.hasClass("open");t.length&&(t.remove(),create_nice_select(e,"moh"),a&&e.next().trigger("click"))}));let w="",k=$("#locales_tenant");for(let e=0;e<locale_list.length;e++)w+='<option data-label="'+locale_list[e].locale_text+'" value="'+locale_list[e].locale+'">'+locale_list[e].locale_text+"</option>";k.append(w),k.each((function(){let e=$(this),t=$(this).next(".nice-select"),a=t.hasClass("open");t.length&&(t.remove(),create_nice_select(e,"locales"),a&&e.next().trigger("click"))}));let x="",E="";for(let e=0;e<codec_list.length;e++)"alaw"==codec_list[e].value?(x+='<div class="form-group form-check-inline"><label class="container_check version_2">'+codec_list[e].name+'<input type="checkbox" name="active_codec" data-label="'+codec_list[e].name+'" value="'+codec_list[e].value+'" class="" checked><span class="checkmark"></span></label></div>',E+='<div class="form-group form-check-inline"><label class="container_check version_2">'+codec_list[e].name+'<input type="checkbox" name="active_codec_webrtc" data-label="'+codec_list[e].name+'" value="'+codec_list[e].value+'" class="" checked><span class="checkmark"></span></label></div>'):(x+='<div class="form-group form-check-inline"><label class="container_check version_2">'+codec_list[e].name+'<input type="checkbox" name="active_codec" data-label="'+codec_list[e].name+'" value="'+codec_list[e].value+'" class=""><span class="checkmark"></span></label></div>',E+='<div class="form-group form-check-inline"><label class="container_check version_2">'+codec_list[e].name+'<input type="checkbox" name="active_codec_webrtc" data-label="'+codec_list[e].name+'" value="'+codec_list[e].value+'" class=""><span class="checkmark"></span></label></div>');document.getElementById("codec_activable").innerHTML=x,document.getElementById("codec_activable_webrtc").innerHTML=E,document.getElementById("client_site_name").innerHTML=a.items[0].name,document.getElementsByName("lang")[0].innerHTML=clm.getCountryNameByAlpha2(m.slice(-2)),document.getElementsByName("codec")[0].innerHTML=d,document.getElementsByName("codec_webrtc")[0].innerHTML=b,document.getElementsByName("apps_webrtc")[0].innerHTML=c,"yes"===_.rtp_symmetric&&"yes"===_.rewrite_contact?document.getElementsByName("nat")[0].innerHTML="Oui":document.getElementsByName("nat")[0].innerHTML="Non",void 0===_.moh_suggest?document.getElementsByName("moh")[0].innerHTML="Option non définie":document.getElementsByName("moh")[0].innerHTML=_.moh_suggest})();